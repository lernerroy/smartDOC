sap.ui.define(["./BaseController","sap/ui/core/routing/History","sap/f/LayoutType","sap/ui/model/json/JSONModel","../utils/formatters","sap/ui/Device"],function(t,e,a,r,s,i){"use strict";return t.extend("airportprofile.controller.Vendors",{formatter:s,onInit:function(){var t=new r({airportId:""});this.setModel(t,"vendorsView");this.getRouter().getRoute("Vendors").attachPatternMatched(this._onObjectMatched,this);this.getRouter().getRoute("Charges").attachPatternMatched(this._onObjectMatched,this);var e=new r({vendorContracts:[]});this.setModel(e,"vendorContracts")},_onObjectMatched:function(t){var e=t.getParameter("name");var r=t.getParameter("arguments");var s=t.getParameter("arguments").id;this.routeParams=r;this.getModel("appView").setProperty("/currentAirportId",s);if(e==="Vendors"){this.getModel("appView").setProperty("/layout",a.OneColumn);this.getModel("appView").setProperty("/mainTabsVisible",true);this.getModel("vendorsView").setProperty("/airportId",r.id);this.loadData(r.id)}else if(e==="Charges"){if(!this.dataLoaded){this.loadData(r.id,r.vid)}else{this._setSelectedListItem(r.vid)}}},navToAirports:function(){this.getRouter().navTo("Airports",{},true)},onNavBack:function(){var t=e.getInstance().getPreviousHash();if(t!==undefined){history.go(-1)}else{this.navToAirports()}},_setSelectedListItem:function(t){var e=this.getModel("vendorContracts");var a=e.getProperty("/vendorContracts");a.forEach(e=>{e.contracts.forEach(e=>{e.selected=e.ID===t})});e.refresh()},loadData:function(t,e){var a="";if(sap.ushell){a=sap.ushell.Container.getUser().getEmail()}var r=this.getModel("vendorContracts");var s=this;const i=this.getModel().sServiceUrl+"PurDocs";$.get({url:i,data:{$filter:`airport_ID eq '${t}' and (IsActiveEntity eq false or SiblingEntity/IsActiveEntity eq null)`,$expand:"status,DraftAdministrativeData"},success:function(t){s.dataLoaded=true;var i=[];t.value.forEach(function(t){t.selected=t.ID===e;t.inProcessByMe=t.DraftAdministrativeData&&t.DraftAdministrativeData.InProcessByUser===a;t.showDraftIndicator=!t.IsActiveEntity&&!t.HasDraftEntity||t.IsActiveEntity&&t.HasDraftEntity&&t.DraftAdministrativeData.LastChangedByUser===a;t.showUnsavedChangesIndicator=t.IsActiveEntity&&t.HasDraftEntity&&t.DraftAdministrativeData.LastChangedByUser!==a;if(t.showUnsavedChangesIndicator){t.draftLastChangedByText=`${this.getResourceBundle().getText("unsavedChangesBy")} ${t.DraftAdministrativeData.LastChangedByUser}`}t.showLockedIndicator=t.IsActiveEntity&&t.HasDraftEntity&&t.DraftAdministrativeData.LastChangedByUser!==a&&t.DraftAdministrativeData.InProcessByUser;if(t.showLockedIndicator){t.lockedText=`${this.getResourceBundle().getText("lockedBy")} ${t.DraftAdministrativeData.LastChangedByUser}`}var r=i.find(e=>e.vendor_ID===t.vendor_ID);if(r){r.contracts.push(t)}else{i.push({vendor_ID:t.vendor_ID,contracts:[t]})}});r.setProperty("/vendorContracts",i)}})},onContractItemClicked:function(t){var e=t.getParameter("listItem");var a=e.getBindingContextPath();var r=this.getModel("vendorContracts").getProperty(a).ID;this._setSelectedListItem(r);var s=this.getModel("vendorsView").getProperty("/airportId");var o=!i.system.phone;this.getRouter().navTo("Charges",{id:s,vid:r},false)},onNewContractButtonPressed:function(){var t=this.getModel().sServiceUrl+"PurDocs";var e={validFrom:"1900-01-01T00:00:00.000Z"};this.showBusyIndicator(true);var a=this;$.ajax({url:t,type:"POST",data:JSON.stringify(e),headers:{"Content-Type":"application/json;IEEE754Compatible=true"},dataType:"json",success:function(t){a.showBusyIndicator(false);setTimeout(function(){a.getRouter().navTo("Charges",{id:a.routeParams.id,vid:t.ID},false)},10)},error:function(t){a.showBusyIndicator(false)}})}})});