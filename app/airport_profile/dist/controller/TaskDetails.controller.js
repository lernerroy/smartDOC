sap.ui.define(["./BaseController","sap/f/LayoutType","sap/ui/model/json/JSONModel","../utils/formatters","sap/ui/core/Fragment"],function(e,t,r,o,a){"use strict";return e.extend("airportprofile.controller.TaskDetails",{formatter:o,onInit:function(){var e=new r({title:this.getResourceBundle().getText("airportProfileTitle"),selectedTabKey:"airportCharges",currentLocationText:"",icon:""});this.setModel(e,"taskDetailsViewModel");var t=new r({airportCharges:[],cargoCharges:[],items:[],versions:[]});this.setModel(t,"taskDetailsDataModel");var o=new r({busy:false,title:"",services:[]});this.setModel(o,"servicesDialogModel");this.getRouter().getRoute("TaskDetails").attachPatternMatched(this._onObjectMatched,this);this.getRouter().getRoute("Services").attachPatternMatched(this._onObjectMatched,this)},navToAirports:function(){this.getRouter().navTo("Airports",{},true)},_onObjectMatched:function(e){var r=e.getParameter("name");var o=e.getParameter("arguments");this.routeParams=o;this.getModel("appView").setProperty("/mainTabsVisible",true);this.getModel("appView").setProperty("/currentSelectedTabKey",o.type);var a=this._getViewModel();if(o.type==="arr"){a.setProperty("/title",`${this.getResourceBundle().getText("airportProfileTitle")} - ${this.getResourceBundle().getText("arrival")}`);a.setProperty("/currentLocationText",this.getResourceBundle().getText("arrival"))}else{a.setProperty("/title",`${this.getResourceBundle().getText("airportProfileTitle")} - ${this.getResourceBundle().getText("departure")}`);a.setProperty("/currentLocationText",this.getResourceBundle().getText("departure"))}if(r==="TaskDetails"){this.getModel("appView").setProperty("/layout",t.OneColumn);this.loadVersions(o.type,o.id)}else{if(!this.versionsLoaded){this.loadVersions(o.type,o.id);this.itemIdToSelect=o.itemid}}},_getViewModel:function(){return this.getModel("taskDetailsViewModel")},_getDataModel:function(){return this.getModel("taskDetailsDataModel")},_getServicesDataModel:function(){return this.getModel("servicesDialogModel")},_clearServicesDataModel:function(){var e=this._getServicesDataModel();e.setProperty("/busy",false);e.setProperty("/services",[]);e.setProperty("/title","")},loadVersions:function(e,t){var r=this.getModel().sServiceUrl+"TaskLists";var o=this._getDataModel();var a=this;let s=null;var i="";if(e==="dep"){i=`origin_ID eq '${t}'`}else if(e==="arr"){i=`destination_ID eq '${t}'`}$.get({url:r,data:{$filter:i,$orderby:"validTo desc","sap-valid-from":"date'1900-01-01'"},success:function(e){a.versionsLoaded=true;var t=_.cloneDeep(e.value);t.forEach(function(e){e.version=`${moment(e.validFrom).format("MMM Do YY")} - ${moment(e.validTo).format("MMM Do YY")}`;e.selected=false;e.isCurrent=moment().isBetween(e.validFrom,e.validTo);if(e.isCurrent){s=e.ID}});o.setProperty("/versions",t);if(s){var r=a.getView().byId("versionsComboBox");if(r){r.setSelectedKey(s)}a.loadData(s)}},error:function(e){console.log(e)}})},onVersionSelectionChanged:function(e){var t=e.getSource().getSelectedKey();this.loadData(t)},loadData:function(e){var t=this;t.showBusyIndicator(true);var r=this._getDataModel();r.setProperty("/items",[]);const o=`${this.getModel().sServiceUrl}TaskLists`;$.get({url:`${o}(ID=${e},IsActiveEntity=true)/items`,data:{$expand:"purDoc,status,domesticIntl,serviceType"},success:function(e){t.showBusyIndicator(false);t._mapDataToModel(e.value);t._displayItemsBySelectedTabKey();if(t.itemIdToSelect){t._selectItemById(t.itemIdToSelect)}t.itemIdToSelect=null},error:function(e){t.showBusyIndicator(false)}})},_deslectAllItems:function(){var e=this._getDataModel();var t=e.getProperty("/airportCharges");t.forEach(function(e){e.selected=false});var r=e.getProperty("/cargoCharges");r.forEach(function(e){e.selected=false});e.refresh()},_selectItemById:function(e){if(!e){return}this._deslectAllItems();var t=this._getDataModel();var r=this._getViewModel();var o=null;var a=t.getProperty("/airportCharges");o=a.find(function(t){return t.ID===e});if(o){o.selected=true;t.refresh();r.setProperty("/selectedTabKey","airportCharges");return}var s=t.getProperty("/cargoCharges");o=s.find(function(t){return t.ID===e});if(o){o.selected=true;t.refresh();r.setProperty("/selectedTabKey","cargoCharges")}},onLobItemPressed:function(e){var r=e.getParameter("listItem");var o=r.getBindingContextPath();var a=this._getDataModel().getProperty(o);this.getModel("appView").setProperty("/layout",t.TwoColumnsBeginExpanded);this._selectItemById(a.ID);this.getRouter().navTo("Services",{id:this.routeParams.id,type:this.routeParams.type,uid:a.purDoc_ID,itemid:a.ID,tid:a.up__ID},false)},onContractIdPressed:function(e){var t=e.getSource().getParent().getBindingContextPath();var o=this._getDataModel().getProperty(t);var s=e.getSource();var i=this;if(!this.getModel("contractData")){var n=new r(o.purDoc);this.setModel(n,"contractData")}else{this.getModel("contractData").setData(o.purDoc);this.getModel("contractData").refresh(true)}if(!this._contractPopover){this._contractPopover=a.load({id:i.getView().getId(),name:"airportprofile.fragments.contractPopover",controller:this}).then(function(e){i.getView().addDependent(e);return e})}this._contractPopover.then(function(e){e.openBy(s)})},onCloseServicesDialogPressed:function(){this.servicesDialog.close()},_loadLobItemServices:function(e){var t=this;const r=`${this.getModel().sServiceUrl}TaskListItems`;this._getServicesDataModel().setProperty("/busy",true);$.get({url:`${r}(up__ID=${e.up__ID},ID='${e.ID}',IsActiveEntity=${e.IsActiveEntity})/purItem`,data:{$expand:`purItem($select=ID,description,brf_id,status,serviceNumber_ID;$expand=up_($expand=items))`},success:function(e){if(e&&e.value){var r=e.value.map(function(e){return e.purItem});t._getServicesDataModel().setProperty("/services",r);t._getServicesDataModel().setProperty("/busy",false)}},error:function(e){t._getServicesDataModel().setProperty("/busy",false)}})},_mapDataToModel(e){var t=this._getDataModel();var r=e.map(function(e){e.effectiveDate=`${moment(e.validFrom).format("MMM Do YY")} - ${moment(e.validTo).format("MMM Do YY")}`;return e});var o=r.filter(function(e){return e.lineOfBusiness==="airport"});var a=r.filter(function(e){return e.lineOfBusiness==="cargo"});t.setProperty("/airportCharges",o);t.setProperty("/cargoCharges",a)},_displayItemsBySelectedTabKey:function(){var e=this._getDataModel();var t=this.getModel("taskDetailsViewModel").getProperty("/selectedTabKey");switch(t){case"airportCharges":e.setProperty("/items",e.getProperty("/airportCharges"));break;case"cargoCharges":e.setProperty("/items",e.getProperty("/cargoCharges"));break}},onLobTabSelected:function(){this._displayItemsBySelectedTabKey();this.getModel("appView").setProperty("/layout",t.OneColumn)},onBrfButtonPressed:function(e){var t=e.getSource().getParent();var r=t.getBindingContextPath();var o=this.getModel("detailsModel").getProperty(r)},onServicesButtonPressed:function(e){var t=e.getSource().getParent().getBindingContextPath();var r=this._getDataModel().getProperty(t)}})});