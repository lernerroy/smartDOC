sap.ui.define(["./BaseController","sap/f/LayoutType","sap/ui/model/json/JSONModel","../utils/formatters","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/ListItem","sap/m/MessageBox","../utils/draftUtils","sap/m/MessagePopover","sap/m/MessagePopoverItem"],function(e,t,a,i,s,r,n,o,d,l,h,c){"use strict";return e.extend("airportprofile.controller.TaskDetails",{formatter:i,onInit:function(){var e=new a({title:this.getResourceBundle().getText("airportProfileTitle"),selectedTabKey:"airport",currentLocationText:"",icon:"",draftMode:false,modes:{create:false,edit:false,displayWithDraft:false,displayWithoutDraft:false,locked:false},domesticIntlItems:[{code:"I",name:"International"},{code:"D",name:"Domestic"}]});this.setModel(e,"taskDetailsViewModel");this.getRouter().getRoute("TaskDetails").attachPatternMatched(this._onObjectMatched,this);this.getRouter().getRoute("Services").attachPatternMatched(this._onObjectMatched,this);var t=this;this._hashHandler=function(){var e;var a=function(i){var s=i.oldURL.substr(i.oldURL.search("#")+1);var r=i.newURL.substr(i.newURL.search("#")+1);if(e!==s){return}if(t._getViewModel().getProperty("/draftMode")){window.hasher.setHash(s.substr(1));if(t.formChanged){t.onCancelVersionDraft(r)}}else{window.removeEventListener("hashchange",a);window.hasher.setHash(s.substr(1));window.hasher.changed.active=true;window.hasher.setHash(r.substr(1))}};return{startManualHashChangeHandling:function(){e=window.location.hash.substr(1);window.hasher.changed.active=false;window.addEventListener("hashchange",a)},stopManualHashChangeHandling:function(){window.hasher.changed.active=true;window.removeEventListener("hashchange",a)}}}()},navToAirports:function(){this.getRouter().navTo("Airports",{},true)},onEditVersionPressed:function(){var e=this.getModel().bindContext("smartDOCDraft.draftEdit(...)",this.oVersionContext);var t=this;e.execute().then(function(e){t.loadVersions(t.routeParams.type,t.routeParams.id,e)}.bind(this)).catch(function(e){var a=e.message;if(!a&&e.responseJSON){a=e.responseJSON.error.message}t.showMessageDialog("Error",a)})},onDeleteVersionPressed:function(){var e=this.oVersionContext.getObject();var t=`Delete the object ${e.extenalID} (${e.description})`;var a=this;d.warning(t,{actions:["Delete",d.Action.CANCEL],emphasizedAction:"Delete",onClose:function(e){if(e==="Delete"){a._deleteContext(a.oVersionContext)}}})},_deleteContext:function(e){var t=this;e.delete().then(function(){t.loadVersions(t.routeParams.type,t.routeParams.id)}).catch(function(e){t.showMessageDialog("Error",e.responseJSON.error.message)})},_onObjectMatched:function(e){var a=e.getParameter("arguments");this.routeParams=a;var i=e.getParameter("name");this.getModel("appView").setProperty("/mainTabsVisible",true);this.getModel("appView").setProperty("/currentAirportId",this.routeParams.id);this.getModel("appView").setProperty("/currentSelectedTabKey",a.type);if(i!=="Services"){this.getModel("appView").setProperty("/layout",t.OneColumn)}else{var s=this.getView().byId("lobTableItems");s.attachUpdateFinished(null,function(){var e=s.getItems();var t=this.routeParams.lobItemId;var a=e.find(function(e){var a=e.getBindingContext().getObject();if(a.ID===t){return e}});if(a){a.setSelected(true)}else{this._hashHandler.stopManualHashChangeHandling();this.onNavBack("TaskDetails")}},this)}if(this.oVersionContext&&i==="Services"){return}this.loadVersions(a.type,a.id)},_updateFormMode:function(e){var t="";if(sap.ushell){t=sap.ushell.Container.getUser().getEmail()}var a=e.DraftAdministrativeData&&e.DraftAdministrativeData.DraftIsCreatedByMe&&!e.IsActiveEntity&&!e.HasActiveEntity&&!e.HasDraftEntity?true:false;var i=e.DraftAdministrativeData&&e.DraftAdministrativeData.DraftIsCreatedByMe&&!e.IsActiveEntity&&e.HasActiveEntity&&!e.HasDraftEntity?true:false;var s=e.DraftAdministrativeData&&!e.DraftAdministrativeData.DraftIsCreatedByMe&&e.IsActiveEntity&&!e.HasActiveEntity&&e.HasDraftEntity?true:false;var r=!e.DraftAdministrativeData&&e.IsActiveEntity&&!e.HasDraftEntity&&e.HasDraftEntity?true:false;var n=e.IsActiveEntity&&e.HasDraftEntity&&e.DraftAdministrativeData.LastChangedByUser!==t&&e.DraftAdministrativeData.InProcessByUser?true:false;this._getViewModel().setProperty("/modes",{create:a,edit:i,displayWithDraft:s,displayWithoutDraft:r,locked:n});this._getViewModel().setProperty("/draftMode",a||i);if(a||i){this.formChanged=true;this._hashHandler.startManualHashChangeHandling()}else{this._hashHandler.stopManualHashChangeHandling()}},_getViewModel:function(){return this.getModel("taskDetailsViewModel")},_getDataModel:function(){return this.getModel("taskDetailsDataModel")},_getServicesDataModel:function(){return this.getModel("servicesDialogModel")},_clearServicesDataModel:function(){var e=this._getServicesDataModel();e.setProperty("/busy",false);e.setProperty("/services",[]);e.setProperty("/title","")},onMessagesIndicatorPressed:function(e){var t=e.getSource();if(!this._messagePopover){this._messagePopover=new h({items:{path:"message>/",template:new c({description:"{message>description}",type:"{message>type}",title:"{message>message}"})}});t.addDependent(this._messagePopover)}this._messagePopover.toggle(t)},loadVersions:function(e,t,a=null){var i=[];if(e==="arr"){i.push(new r({path:"destination_ID",operator:n.EQ,value1:t}))}else if(e==="dep"){i.push(new r({path:"origin_ID",operator:n.EQ,value1:t}))}i.push(new r({filters:[new r({path:"IsActiveEntity",operator:n.EQ,value1:false}),new r({path:"SiblingEntity/IsActiveEntity",operator:n.EQ,value1:null})],and:false}));var s=this.getView().byId("versionsComboBox");var d=this;s.clearSelection();s.bindItems({path:"/TaskLists",filters:i,parameters:{"sap-valid-from":"date'1900-01-01'","sap-valid-to":"date'9999-12-31'",$expand:"DraftAdministrativeData,status",$select:"HasDraftEntity"},template:new o({key:"{ID}",text:{parts:[{path:"validFrom",formatter:function(e){return this.formatter.convertDate(e)+" - "}.bind(this)},{path:"validTo",formatter:this.formatter.convertDate}]},additionalText:{path:"IsActiveEntity",formatter:function(e){if(e==="No"){return"Draft"}else{return""}}.bind(this)}}),events:{dataReceived:function(e){var t=e.getSource().getContexts();if(t&&t.length>0){var i=null;if(a){i=t.find(e=>{if(e.sPath===a.sPath){return e}})}else{i=t[0]}var r=i.getObject();d.oVersionContext=i;s.setSelectedKey(r.ID);d._bindView(i);d._bindLobTableItems(i);d._updateFormMode(r)}else{d.oVersionContext=null;d.getView().unbindElement()}}}})},_bindView:function(e){this.getView().bindElement({path:e.getPath()})},_unbindLobTableItems:function(){var e=this.getView().byId("lobTableItems");e.unbindItems()},_bindLobTableItems:function(e){var t=this.getView().byId("lobTableItems");var a=t.getBinding("items");var i=this._getViewModel().getProperty("/selectedTabKey");a.filter(new r({path:"lineOfBusiness",operator:n.EQ,value1:i}))},onAddNewVersionClicked:function(){var e=this;var t=new a({title:"New Version",busy:false,validFromDate:"",validToDate:""});e.getView().setModel(t,"newVersionModel");s.load({id:e.getView().getId(),name:"airportprofile.fragments.createVersion",controller:this}).then(function(t){e._newVersionDialog=t;e.getView().addDependent(t);t.open();t.attachAfterClose(null,function(t){t.getSource().destroy();e.getView().setModel(null,"newVersionModel")},this)})},onAddLobItem:function(){var e=this.getView().byId("lobTableItems");var t=e.getBinding("items");var a=this._getViewModel().getProperty("/selectedTabKey");t.create({extenalID:"00010",validFrom:moment(new Date,"YYYY-MM-DD HH:mm:ss.SS"),validTo:moment("9999-12-31","YYYY-MM-DD HH:mm:ss.SS"),IsActiveEntity:true,additionalIndicator:true,status_code:"A",serviceType_code:"",domesticIntl_code:"",lineOfBusiness:a,jobIndicator:true,description:undefined},false,false,false);oDataListBinding.attachCreateCompleted(function(e){},this)},onCloseVersionDialog:function(){this._newVersionDialog.close()},onCreateVersionClicked:function(e){var t=e.getSource().getParent();var a=this.getView().getModel("newVersionModel");var i=a.getProperty("/validFromDate");var s=a.getProperty("/validToDate");if(!i||!s){return}var r={validFrom:moment(i,"YYYY-MM-DD HH:mm:ss.SS"),validTo:moment(s,"YYYY-MM-DD HH:mm:ss.SS")};if(this.routeParams.type==="arr"){r.destination_ID=this.routeParams.id}else if(this.routeParams.type==="dep"){r.origin_ID=this.routeParams.id}var n=this.getModel().bindList("/TaskLists");a.setProperty("/busy",true);n.create(r);var o=this;n.attachCreateCompleted(function(e){a.setProperty("/busy",false);t.close();var i=e.getParameter("context");o.loadVersions(o.routeParams.type,o.routeParams.id,i)},this)},onSaveVersionDraft:function(){var e=this.getModel().bindContext("smartDOCDraft.draftActivate(...)",this.oVersionContext);var t=this;e.execute().then(function(e){this.oVersionContext=e;this._bindView(e);t._bindLobTableItems(e);t._updateFormMode(e.getObject());var a=t.getView().byId("versionsComboBox");a.getBinding("items").refresh()}.bind(this))},onCancelVersionDraft:function(e=null){var t=this;l.handleDraftSaveChanges(this.getResourceBundle(),{onKeepDraft:function(){t._getViewModel().setProperty("/draftMode",false);if(e!==null){window.hasher.setHash(e.substr(1))}else{t.onNavBack("Airports")}},onDiscardDraft:function(){t._deleteContext(t.oVersionContext)},onCancel:function(){}})},onVersionSelectionChanged:function(e){this.oVersionContext=e.getParameter("selectedItem").getBindingContext();this._bindView(this.oVersionContext);this._updateFormMode(this.oVersionContext.getObject())},onLobItemPressed:function(e){var a=e.getParameter("listItem");var i=a.getBindingContext().getObject();this.getModel("appView").setProperty("/layout",t.TwoColumnsBeginExpanded);this._hashHandler.stopManualHashChangeHandling();this.getRouter().navTo("Services",{id:this.routeParams.id,type:this.routeParams.type,contractId:i.purDoc_ID,lobItemId:i.ID,taskId:i.up__ID},false);if(this._getViewModel().getProperty("/draftMode")){this._hashHandler.startManualHashChangeHandling()}},onContractIdPressed:function(e){var t=e.getSource().getParent().getBindingContextPath();var i=this._getDataModel().getProperty(t);var r=e.getSource();var n=this;if(!this.getModel("contractData")){var o=new a(i.purDoc);this.setModel(o,"contractData")}else{this.getModel("contractData").setData(i.purDoc);this.getModel("contractData").refresh(true)}if(!this._contractPopover){this._contractPopover=s.load({id:n.getView().getId(),name:"airportprofile.fragments.contractPopover",controller:this}).then(function(e){n.getView().addDependent(e);return e})}this._contractPopover.then(function(e){e.openBy(r)})},onCloseServicesDialogPressed:function(){this.servicesDialog.close()},onLobTabSelected:function(){this.getModel("appView").setProperty("/layout",t.OneColumn);this._bindLobTableItems(this.oVersionContext)},onDeleteLobItem:function(e){var t=e.getSource().getParent().getParent().getBindingContext();t.delete()},onBrfButtonPressed:function(e){var t=e.getSource().getParent();var a=t.getBindingContextPath();var i=this.getModel("detailsModel").getProperty(a)}})});