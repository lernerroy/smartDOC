sap.ui.define(["./BaseController","sap/f/LayoutType","sap/ui/model/json/JSONModel","../utils/formatters","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment"],function(e,t,r,a,i,o,n){"use strict";return e.extend("airportprofile.controller.Services",{formatter:a,onInit:function(){var e=new r({busy:false,title:"",services:[],activeServicesIds:[]});this.setModel(e,"servicesDialogModel");this.getRouter().getRoute("Services").attachPatternMatched(this._onObjectMatched,this)},onDeleteService:function(e){var t=e.getSource().getParent().getBindingContext();t.delete()},_onObjectMatched:function(e){this.getModel("appView").setProperty("/mainTabsVisible",true);this.getModel("appView").setProperty("/layout",t.TwoColumnsBeginExpanded);this.routeParams=e.getParameter("arguments");this._loadContext();this._loadContract()},onClose:function(){this.onNavBack("TaskDetails",{id:this.routeParams.id,type:this.routeParams.type})},_loadContext(){var e=this;var t=[new i({path:"ID",operator:o.EQ,value1:this.routeParams.lobItemId}),new i({path:"up__ID",operator:o.EQ,value1:this.routeParams.taskId}),new i({filters:[new i({path:"IsActiveEntity",operator:o.EQ,value1:false}),new i({path:"SiblingEntity/IsActiveEntity",operator:o.EQ,value1:null})],and:false})];var r=this.getModel().bindList("/TaskListItems",null,null,t,null);r.requestContexts(0,1).then(function(t){if(t&&t.length>0){e.oContext=t[0];e.getView().bindElement({path:e.oContext.getPath()})}else{}}.bind(this)).catch(function(e){}.bind(this))},_loadContract:function(){var e=new i({path:"ID",operator:o.EQ,value1:this.routeParams.contractId});var t=this.getModel().bindList("/PurDocs",null,null,e,null);var r=this;t.requestContexts(0,1).then(function(e){if(e&&e.length>0){r.oContractContext=e[0]}else{}}.bind(this)).catch(function(e){console.log("error",e)}.bind(this))},onCloseServicesDialog:function(e){e.getSource().getParent().close()},onAddSelectedServices:function(e){var t=this.getView().byId("servicesTable");var r=e.getSource().getParent();var a=t.getSelectedItems();if(!a||a.length===0){r.close();return}var i=this.getModel().bindList("/Pur2TL",null,null,null,{});var o=this.oContext.getObject();r.setBusy(true);for(let e of a){var n=e.getBindingContext().getObject();i.create({taskListItem_up__ID:o.up__ID,taskListItem_ID:o.ID,purItem_ID:n.ID,purItem_up__ID:n.up__ID},false,false,false)}i.attachCreateCompleted(function(e){r.setBusy(false);r.close();this.getView().bindElement({path:this.oContext.getPath()})},this)},servicesTableSelectionChanged:function(e){},onAddService:function(){var e=this;n.load({id:e.getView().getId(),name:"airportprofile.fragments.servicesDialog",controller:this}).then(function(t){e._servicesDialog=t;e.getView().addDependent(t);t.open();t.attachAfterClose(null,function(e){e.getSource().destroy()},e);t.bindElement({path:e.oContractContext.getPath()});t.attachAfterOpen(null,function(){var e=this.getView().byId("servicesTable");var t=e.getBinding("items");t.filter(this._getActiveServicesIdsFilter());this.getModel("servicesDialogModel").setProperty("/busy",true);e.attachUpdateFinished(null,function(){this.getModel("servicesDialogModel").setProperty("/busy",false)},this)},e)})},_getActiveServicesIdsFilter:function(){var e=[];var t=this.getView().byId("activeServicesTable");var r=t.getBindingContext().getObject();if(r&&r.purItem){var a=r.purItem.map(function(e){return e.purItem_ID});a.forEach(function(t){e.push(new i({path:"ID",operator:o.NE,value1:t}))})}return new i({filters:e,and:true})},_loadData:function(e,t,r){},_mapDataToModel(e){var t=this._getDataModel();var r=e.map(function(e){e.effectiveDate=`${moment(e.validFrom).format("MMM Do YY")} - ${moment(e.validTo).format("MMM Do YY")}`;return e});var a=r.filter(function(e){return e.lineOfBusiness==="airport"});var i=r.filter(function(e){return e.lineOfBusiness==="cargo"});t.setProperty("/airportCharges",a);t.setProperty("/cargoCharges",i)},_displayItemsBySelectedTabKey:function(){var e=this._getDataModel();var t=this.getModel("taskDetailsViewModel").getProperty("/selectedTabKey");switch(t){case"airportCharges":e.setProperty("/items",e.getProperty("/airportCharges"));break;case"cargoCharges":e.setProperty("/items",e.getProperty("/cargoCharges"));break}},onLobTabSelected:function(){this._displayItemsBySelectedTabKey()},onBrfButtonPressed:function(e){var t=e.getSource().getParent();var r=t.getBindingContextPath();var a=this.getModel("detailsModel").getProperty(r)},onServicesButtonPressed:function(e){var t=e.getSource().getParent().getBindingContextPath();var r=this._getDataModel().getProperty(t)}})});