sap.ui.define(["./BaseController","sap/f/LayoutType","sap/ui/model/json/JSONModel","../utils/formatters","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment"],function(t,e,a,i,r,s,o){"use strict";return t.extend("airportprofile.controller.Charges",{formatter:i,onInit:function(){this._initViewModel();var t=new a({header:{}});this.setModel(t,"detailsModel");var e=this;this.getRouter().getRoute("Charges").attachPatternMatched(this._onObjectMatched,this);this._hashHandler=function(){var t;var a=function(i){var r=i.oldURL.substr(i.oldURL.search("#")+1);var s=i.newURL.substr(i.newURL.search("#")+1);if(t!==r){return}window.removeEventListener("hashchange",a);window.hasher.setHash(r.substr(1));window.hasher.changed.active=true;window.hasher.setHash(s.substr(1));e._getViewModel().setProperty("/editable",false);e._initViewModel();e.stopManualHashChangeHandling()};return{startManualHashChangeHandling:function(){t=window.location.hash.substr(1);window.hasher.changed.active=false;window.addEventListener("hashchange",a)},stopManualHashChangeHandling:function(){window.hasher.changed.active=true;window.removeEventListener("hashchange",a)}}}()},_initViewModel:function(){var t={title:"",editLobDialog:{title:"",busy:false},modes:{create:false,edit:false,displayWithDraft:false,displayWithoutDraft:false,locked:false},lobSelectedTab:"airport",editable:false};var e=this._getViewModel();if(e){e.setData(t)}else{this.setModel(new a(t),"detailsViewModel")}},_getDataModel:function(){return this.getModel("detailsModel")},_getViewModel:function(){return this.getModel("detailsViewModel")},_getLobSelectedTab:function(){return this._getViewModel().getProperty("/lobSelectedTab")},_onObjectMatched:function(t){this._getDataModel().setProperty("/header",{});this.routeParams=t.getParameter("arguments");this.getEventBus().publish("route","charges",t.getParameter("arguments"));this.getModel("appView").setProperty("/layout",e.TwoColumnsMidExpanded);this.loadData(t.getParameter("arguments").vid)},loadData:function(t){const e=this.getModel().sServiceUrl+"PurDocs";var a=this;a.showBusyIndicator(true);$.get({url:e,data:{$select:"IsActiveEntity",$filter:`ID eq ${t} and (IsActiveEntity eq false or SiblingEntity/IsActiveEntity eq null)`},success:function(e){if(e&&e.value.length>0){a.loadContract(t,e.value[0].IsActiveEntity)}},error:function(t){console.log(t);a.showBusyIndicator(false)}})},loadContract:function(t,e){var a=this.getModel("detailsModel");const i=this.getModel().sServiceUrl+"PurDocs";var r=this;$.get({url:`${i}(ID=${t},IsActiveEntity=${e})`,data:{$select:"extenalID,documentDate,description,status,validFrom,validTo,aribaIndicator",$expand:"vendor,carrier,purchaseOrganization,items,status,DraftAdministrativeData"},success:function(t){var e=_.cloneDeep(t);e.airport=[];e.cargo=[];e.engs=[];e.caterings=[];if(t&&t.items){t.items.forEach(function(t){if(t.lineOfBusiness){e[t.lineOfBusiness].push(t)}})}e.items=e.airport;a.setProperty("/header",e);var i=r.getResourceBundle().getText("contract");r.getModel("detailsViewModel").setProperty("/title",`${i} ${t.extenalID} (${t.description})`);r.showBusyIndicator(false);r._updateFormMode(t)},error:function(t){r.showBusyIndicator(false)}})},_updateFormMode:function(t){var e="";if(sap.ushell){e=sap.ushell.Container.getUser().getEmail()}var a=t.DraftAdministrativeData&&t.DraftAdministrativeData.DraftIsCreatedByMe&&!t.IsActiveEntity&&!t.HasActiveEntity&&!t.HasDraftEntity?true:false;var i=t.DraftAdministrativeData&&t.DraftAdministrativeData.DraftIsCreatedByMe&&!t.IsActiveEntity&&t.HasActiveEntity&&!t.HasDraftEntity?true:false;var r=t.DraftAdministrativeData&&!t.DraftAdministrativeData.DraftIsCreatedByMe&&t.IsActiveEntity&&!t.HasActiveEntity&&t.HasDraftEntity?true:false;var s=!t.DraftAdministrativeData&&t.IsActiveEntity&&!t.HasDraftEntity&&t.HasDraftEntity?true:false;var o=item.showLockedIndicator=item.IsActiveEntity&&item.HasDraftEntity&&item.DraftAdministrativeData.LastChangedByUser!==e&&item.DraftAdministrativeData.InProcessByUser?true:false;this._getViewModel().setProperty("/modes",{create:a,edit:i,displayWithDraft:r,displayWithoutDraft:s,locked:o});this._getViewModel().setProperty("/editable",a||i);if(a||i){this._setupEditedContractModel(t)}},vendorOnSuggest:function(t){var e=t.getParameter("suggestValue"),a=[];if(e){a=[new r([new r("ID",s.StartsWith,e),new r("Name",s.StartsWith,e)],false)]}t.getSource().getBinding("suggestionItems").filter(a);t.getSource().suggest()},onCancelCreate:function(){this.onNavBack("Vendors")},onSaveContract:function(){this.activateDraft()},activateDraft:function(t="smartDOCDraft.draftPrepare"){var e=this._getDataModel();var a=e.getProperty("/header/ID");var i=e.getProperty("/header/IsActiveEntity");var r=`${this.getModel().sServiceUrl}PurDocs(ID=${a},IsActiveEntity=${i})/${t}`;var s=this;$.ajax({url:r,type:"POST",data:JSON.stringify({SideEffectsQualifier:""}),headers:{"Content-Type":"application/json;IEEE754Compatible=true"},dataType:"json",success:function(e){if(t==="smartDOCDraft.draftPrepare"){s.activateDraft("smartDOCDraft.draftActivate")}},error:function(t){alert("error");console.log(t)}})},onLobTabSelected:function(t){var e=this.getModel("detailsModel");var a=e.getProperty("/header");var i=t.getParameter("selectedKey");e.setProperty("/header/items",a[i])},onBrfButtonPressed:function(t){var e=t.getSource().getParent();var a=e.getBindingContextPath();var i=this.getModel("detailsModel").getProperty(a);const r={MD_APP_BASE_URL:"BusinessRules-ManageDecision&/RuleServices",REVISIONS:"Revisions"};var s=r.MD_APP_BASE_URL+"/"+i.brf_id;var o=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService&&sap.ushell.Container.getService("CrossApplicationNavigation");o.toExternal({target:{shellHash:s}})},_setupEditedContractModel:function(t){var e=new a({contractItem:null,statusCode:t.status?t.status.code:"",description:t.description,docDate:t.documentDate,validFromDate:t.validFrom,validToDate:t.validTo,carrierId:t.carrier_ID,purchaseOrgId:t.purchaseOrganization_ID,vendorId:t.vendor_ID});this.getView().setModel(e,"editedContract");e.attachPropertyChange(function(){var e=this.getView().getModel("editedContract").getData();this._saveDraftContract(t.ID,t.IsActiveEntity,e)},this);return e},_saveDraftContract:function(t,e,a){var i=`${this.getModel().sServiceUrl}PurDocs(ID=${t},IsActiveEntity=${e})`;var r="PATCH";var s=this.getView().getModel("editedContract");const o={validFrom:a.validFromDate?a.validFromDate:"1900-01-01T00:00:00.000Z",validTo:a.validToDate?a.validToDate:"1900-01-01T00:00:00.000Z",objectType:"contract",documentDate:a.docDate?`${a.docDate}`:"1900-01-01",description:a.description,airport_ID:this.routeParams.id,status_code:a.statusCode,carrier_ID:a.carrierId,purchaseOrganization_ID:a.purchaseOrgId,documentType:"airport",vendor_ID:a.vendorId,aribaIndicator:null};$.ajax({url:i,type:r,data:JSON.stringify(o),headers:{"Content-Type":"application/json;IEEE754Compatible=true"},dataType:"json",success:function(t){s.setProperty("/contractItem",t)},error:function(t){console.log(t)}})},onDeleteContractPressed:function(){const t=this.getModel().sServiceUrl+"PurDocs";var e=this;$.get({url:t,data:{$select:"IsActiveEntity",$filter:`ID eq ${id} and (IsActiveEntity eq false or SiblingEntity/IsActiveEntity eq null)`},success:function(t){debugger;e.showBusyIndicator(false)},error:function(t){e.showBusyIndicator(false)}})},onAddLobItem:function(){var t=this;this._getViewModel().setProperty("/editLobDialog/title","Create Item");var e=new a({status:"",description:"",validFrom:"",validTo:"",price:undefined,quantity:undefined,lineOfBusiness:this._getLobSelectedTab()});this.getView().setModel(e,"editLobData");o.load({name:"airportprofile.fragments.editLob",controller:this}).then(function(e){t._editLobDialog=e;t.getView().addDependent(e);e.open()})},onSaveLob:function(){var t=this._getDataModel().getProperty("/header");var e=`${this.getModel().sServiceUrl}PurDocs(ID=${t.ID},IsActiveEntity=${t.IsActiveEntity})/items`;var a=this.getView().getModel("editLobData").getData();var i={validFrom:`${a.validFrom}T00:00:00.000Z`,validTo:`${a.validTo}T00:00:00.000Z`,status_code:a.status,price:a.price,quantity:a.quantity,description:a.description,lineOfBusiness:a.lineOfBusiness};var r=this;$.ajax({url:e,type:"POST",data:JSON.stringify(i),headers:{"Content-Type":"application/json;IEEE754Compatible=true"},dataType:"json",success:function(t){r.onCloseEditLobDialog();var e=r._getDataModel().getProperty("/header");e[t.lineOfBusiness].push(t);e.items=e[t.lineOfBusiness];r._getDataModel().refresh()},error:function(t){}})},onCloseEditLobDialog:function(){if(this._editLobDialog){this._editLobDialog.close();this._editLobDialog.destroy();this._editLobDialog=null}}})});